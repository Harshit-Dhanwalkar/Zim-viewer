<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust ZIM Viewer - Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .spinner {
        border-top-color: #3b82f6;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
      }
      @-webkit-keyframes spin {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300 relative"
    >
      <h1
        class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-gray-900"
      >
        Rust ZIM Viewer
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Upload a `.zim` file to view its contents
      </p>

      <form
        id="upload-form"
        class="relative w-full border-2 border-dashed border-gray-300 rounded-xl p-6 sm:p-12 text-center transition-colors duration-200 hover:border-blue-500"
      >
        <input
          id="file-upload"
          type="file"
          name="zim_file"
          accept=".zim"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center justify-center space-y-4">
          <svg
            class="w-12 h-12 text-gray-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="17 8 12 3 7 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <line
              x1="12"
              x2="12"
              y1="3"
              y2="15"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p class="text-gray-500 font-medium">
            Drag and drop your file here, or
            <span class="text-blue-600 underline">browse</span>
          </p>
          <p class="text-sm text-gray-400">Supported file type: .zim</p>
        </div>
      </form>

      <div
        id="file-info"
        class="mt-6 p-4 bg-gray-100 rounded-xl flex items-center justify-between hidden"
      >
        <div class="flex items-center space-x-3">
          <svg
            class="w-6 h-6 text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="14 2 14 8 20 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <div>
            <span id="file-name" class="font-medium text-gray-700 block"></span>
            <span id="file-metadata" class="text-xs text-gray-500"></span>
          </div>
        </div>
        <button
          id="remove-file-btn"
          class="rounded-md border border-red-300 bg-white px-4 py-2 text-sm font-medium text-red-700 shadow-sm hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
        >
          Remove
        </button>
      </div>

      <div id="status" class="mt-8"></div>
      <div id="progress-container" class="mt-4 hidden">
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div
            id="progress-bar"
            class="bg-blue-500 h-6 text-xs text-white text-center leading-6"
            style="width: 0%"
          >
            0%
          </div>
        </div>
        <div id="progress-text" class="text-gray-600 text-sm mt-2">
          0 MB processed
        </div>
      </div>

      <div id="loading-spinner" class="mt-8 text-center hidden">
        <div
          class="spinner inline-block w-8 h-8 border-4 border-gray-200 rounded-full"
        ></div>
        <p class="text-gray-500 mt-2">Processing large file, please wait...</p>
      </div>
    </div>

    <script>
      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showLoadingSpinner(show) {
        const spinner = document.getElementById("loading-spinner");
        if (show) {
          spinner.classList.remove("hidden");
        } else {
          spinner.classList.add("hidden");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("upload-form");
        const fileInput = document.getElementById("file-upload");
        const fileInfo = document.getElementById("file-info");
        const fileNameSpan = document.getElementById("file-name");
        const fileMetadataSpan = document.getElementById("file-metadata");
        const removeFileBtn = document.getElementById("remove-file-btn");
        const statusDiv = document.getElementById("status");
        const progressContainer = document.getElementById("progress-container");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        fileInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          fileNameSpan.textContent = file.name;
          fileMetadataSpan.textContent = `File size: ${formatBytes(file.size)}`;
          fileInfo.classList.remove("hidden");
          form.classList.add("hidden");
          progressContainer.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "0 MB processed";
          showLoadingSpinner(true);

          const source = new EventSource("/progress");
          source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const processed = data.processed_bytes;
            const total = file.size;
            const percent = ((processed / total) * 100).toFixed(2);

            progressBar.style.width = percent + "%";
            progressBar.textContent = percent + "%";
            progressText.textContent =
              formatBytes(processed) + " of " + formatBytes(total);
          };

          const formData = new FormData();
          formData.append("zim_file", file);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });
            const result = await response.json();
            source.close();

            if (response.ok) {
              // Redirect to viewer page after successful upload
              window.location.href = "/viewer.html";
            } else {
              statusDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-xl font-medium">${result.message || "Unknown error"}</div>`;
            }
          } catch (e) {
            source.close();
            statusDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-xl font-medium">Error: ${e.message}</div>`;
          } finally {
            showLoadingSpinner(false);
          }
        });

        removeFileBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fileInput.value = null;
          form.classList.remove("hidden");
          fileInfo.classList.add("hidden");
          progressContainer.classList.add("hidden");
        });

        form.addEventListener("dragover", (e) => e.preventDefault());
        form.addEventListener("drop", (e) => {
          e.preventDefault();
          if (e.dataTransfer.files[0]) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event("change"));
          }
        });
      });
    </script>
  </body>
</html>
