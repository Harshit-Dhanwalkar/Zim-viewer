<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust ZIM Viewer - Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .spinner {
        border-top-color: #3b82f6;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
      }
      @-webkit-keyframes spin {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .dark {
        background-color: #0c0a09;
        color: #e5e7eb;
      }
      .dark .bg-gray-900 {
        background-color: #1f2937;
      }
      .dark .text-white {
        color: #fff;
      }
      .dark .text-gray-400 {
        color: #9ca3af;
      }
      .dark .border-gray-700 {
        border-color: #374151;
      }
      .dark .bg-gray-800 {
        background-color: #1f2937;
      }
      .dark .text-gray-300 {
        color: #d1d5db;
      }
      .dark .text-gray-500 {
        color: #6b7280;
      }
      .dark .border-red-700 {
        border-color: #dc2626;
      }
      .dark .text-red-400 {
        color: #fca5a5;
      }
      .dark .hover:bg-red-900:hover {
        background-color: #7f1d1d;
      }
      .dark .bg-gray-700 {
        background-color: #374151;
      }
      .dark .bg-red-900 {
        background-color: #7f1d1d;
      }
      .dark .text-red-300 {
        color: #fca5a5;
      }

      .light {
        background-color: #fafafa;
        color: #374151;
      }
      .light .bg-white {
        background-color: #fff;
      }
      .light .text-gray-900 {
        color: #111827;
      }
      .light .text-gray-600 {
        color: #4b5563;
      }
      .light .border-gray-300 {
        border-color: #d1d5db;
      }
      .light .bg-gray-100 {
        background-color: #f3f4f6;
      }
      .light .text-gray-700 {
        color: #374151;
      }
      .light .border-red-300 {
        border-color: #fca5a5;
      }
      .light .text-red-700 {
        color: #b91c1c;
      }
      .light .hover:bg-red-50:hover {
        background-color: #fef2f2;
      }
      .light .bg-gray-200 {
        background-color: #e5e7eb;
      }
      .light .bg-red-100 {
        background-color: #fef2f2;
      }
    </style>
  </head>
  <body
    class="flex items-center justify-center min-h-screen p-4 transition-colors duration-300"
  >
    <button
      id="theme-toggle"
      type="button"
      class="fixed top-4 right-4 p-2 rounded-full transition-colors duration-200"
    >
      <svg
        id="sun-icon"
        class="w-6 h-6 text-yellow-500"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.18a.75.75 0 00-1.061-1.061l-1.591 1.59a.75.75 0 101.06 1.06l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM16.442 18.894a.75.75 0 001.06 1.06l1.591-1.59a.75.75 0 00-1.06-1.06l-1.591 1.59zM12 21.75a.75.75 0 01-.75-.75v-2.25a.75.75 0 011.5 0v2.25a.75.75 0 01-.75.75zM7.558 18.894a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.06l1.59-1.59zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM6.18 5.106a.75.75 0 00-1.061 1.061l1.59 1.591a.75.75 0 001.06-1.06l-1.59-1.591z"
        />
      </svg>
      <svg
        id="star-icon"
        class="w-6 h-6 text-yellow-300 hidden"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          d="M12 2L9.19 8.64L2 9.27L7.46 13.5L5.82 20L12 16.14L18.18 20L16.54 13.5L22 9.27L14.81 8.64L12 2Z"
        />
      </svg>
    </button>
    <div
      class="w-full max-w-4xl shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300 relative"
    >
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <a
          href="https://github.com/Harshit-Dhanwalkar/Zim-viewer"
          target="_blank"
          rel="noopener noreferrer"
          class="order-last sm:order-first text-gray-400 hover:text-blue-500 transition-colors duration-200 mt-4 sm:mt-0 sm:ml-0"
        >
          <svg
            class="w-8 h-8"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              fill-rule="evenodd"
              d="M12 2C6.477 2 2 6.484 2 12.017c0 4.418 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.368-1.343-3.368-1.343-.455-1.166-1.114-1.474-1.114-1.474-.91-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.956 0-1.091.39-1.984 1.029-2.682-.103-.253-.446-1.272.098-2.651 0 0 .84-.268 2.75 1.022A9.637 9.637 0 0 1 12 6.844c.85.004 1.701.11 2.516.326 1.909-1.29 2.747-1.022 2.747-1.022.546 1.379.202 2.398.099 2.651.64.698 1.028 1.591 1.028 2.682 0 3.85-2.339 4.691-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0 0 22 12.017C22 6.484 17.522 2 12 2Z"
              clip-rule="evenodd"
            />
          </svg>
        </a>
        <div class="flex-grow text-center">
          <h1 class="text-3xl sm:text-4xl font-extrabold mb-2 text-current">
            Rust ZIM Viewer
          </h1>
          <p class="text-sm text-current mb-4">
            Upload a `.zim` file to view its contents
          </p>
        </div>
        <div class="w-8 h-8 order-first sm:order-last"></div>
      </div>

      <form
        id="upload-form"
        class="relative w-full border-2 border-dashed rounded-xl p-6 sm:p-12 text-center transition-colors duration-200 hover:border-blue-500"
      >
        <input
          id="file-upload"
          type="file"
          name="zim_file"
          accept=".zim"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center justify-center space-y-4">
          <svg
            class="w-12 h-12 text-gray-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="17 8 12 3 7 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <line
              x1="12"
              x2="12"
              y1="3"
              y2="15"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p class="text-current font-medium">
            Drag and drop your file here, or
            <span class="text-blue-400 underline">browse</span>
          </p>
          <p class="text-sm text-gray-500">Supported file type: .zim</p>
        </div>
      </form>

      <div
        id="file-info"
        class="mt-6 p-4 rounded-xl flex items-center justify-between border-2 border-gray-300 dark:border-gray-700 hidden"
      >
        <div class="flex items-center space-x-3">
          <svg
            class="w-6 h-6 text-blue-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="14 2 14 8 20 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <div>
            <span id="file-name" class="font-medium block text-current"></span>
            <span id="file-metadata" class="text-xs text-current"></span>
          </div>
        </div>
        <button
          id="remove-file-btn"
          class="rounded-md border px-4 py-2 text-sm font-medium shadow-sm transition-colors duration-200"
        >
          Remove
        </button>
      </div>

      <div id="status" class="mt-8"></div>
      <div id="progress-container" class="mt-4 hidden">
        <div class="w-full rounded-full h-6 overflow-hidden">
          <div
            id="progress-bar"
            class="bg-blue-500 h-6 text-xs text-white text-center leading-6"
            style="width: 0%"
          >
            0%
          </div>
        </div>
        <div id="progress-text" class="text-current text-sm mt-2">
          0 MB processed
        </div>
      </div>

      <div id="loading-spinner" class="mt-8 text-center hidden">
        <div class="spinner inline-block w-8 h-8 border-4 rounded-full"></div>
        <p class="text-current mt-2">Processing large file, please wait...</p>
      </div>
    </div>

    <script>
      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showLoadingSpinner(show) {
        const spinner = document.getElementById("loading-spinner");
        if (show) {
          spinner.classList.remove("hidden");
        } else {
          spinner.classList.add("hidden");
        }
      }

      const body = document.body;
      const themeToggle = document.getElementById("theme-toggle");
      const sunIcon = document.getElementById("sun-icon");
      const starIcon = document.getElementById("star-icon");

      function updateThemeClasses(isDark) {
        body.classList.toggle("light", !isDark);
        body.classList.toggle("dark", isDark);

        const card = document.querySelector(".max-w-4xl");
        card.classList.toggle("bg-white", !isDark);
        card.classList.toggle("bg-gray-900", isDark);

        const form = document.getElementById("upload-form");
        form.classList.toggle("border-gray-300", !isDark);
        form.classList.toggle("border-gray-700", isDark);

        const fileInfo = document.getElementById("file-info");
        fileInfo.classList.toggle("bg-gray-100", !isDark);
        fileInfo.classList.toggle("bg-gray-800", isDark);
        // Added border classes for file info section
        fileInfo.classList.toggle("border-gray-300", !isDark);
        fileInfo.classList.toggle("dark:border-gray-700", isDark);

        const fileNameSpan = document.getElementById("file-name");
        fileNameSpan.classList.toggle("text-gray-700", !isDark);
        fileNameSpan.classList.toggle("text-gray-300", isDark);

        const fileMetadataSpan = document.getElementById("file-metadata");
        fileMetadataSpan.classList.toggle("text-gray-500", !isDark);
        fileMetadataSpan.classList.toggle("text-gray-500", isDark);

        const removeFileBtn = document.getElementById("remove-file-btn");
        removeFileBtn.classList.toggle("border-red-300", !isDark);
        removeFileBtn.classList.toggle("bg-white", !isDark);
        removeFileBtn.classList.toggle("text-red-700", !isDark);
        removeFileBtn.classList.toggle("hover:bg-red-50", !isDark);
        removeFileBtn.classList.toggle("border-red-700", isDark);
        removeFileBtn.classList.toggle("bg-gray-800", isDark);
        removeFileBtn.classList.toggle("text-red-400", isDark);
        removeFileBtn.classList.toggle("hover:bg-red-900", isDark);

        const statusDiv = document
          .getElementById("status")
          .querySelector("div");
        if (statusDiv) {
          statusDiv.classList.toggle("bg-red-100", !isDark);
          statusDiv.classList.toggle("text-red-700", !isDark);
          statusDiv.classList.toggle("bg-red-900", isDark);
          statusDiv.classList.toggle("text-red-300", isDark);
        }

        const progressContainerDiv = document.querySelector(
          "#progress-container > div",
        );
        progressContainerDiv.classList.toggle("bg-gray-200", !isDark);
        progressContainerDiv.classList.toggle("bg-gray-700", isDark);

        const spinner = document.querySelector("#loading-spinner > div");
        spinner.classList.toggle("border-gray-200", !isDark);
        spinner.classList.toggle("border-gray-700", isDark);
      }

      function setTheme(isDark) {
        if (isDark) {
          localStorage.setItem("theme", "dark");
          body.classList.add("dark");
          body.classList.remove("light");
          sunIcon.classList.add("hidden");
          starIcon.classList.remove("hidden");
        } else {
          localStorage.setItem("theme", "light");
          body.classList.add("light");
          body.classList.remove("dark");
          sunIcon.classList.remove("hidden");
          starIcon.classList.add("hidden");
        }
        updateThemeClasses(isDark);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("upload-form");
        const fileInput = document.getElementById("file-upload");
        const fileInfo = document.getElementById("file-info");
        const fileNameSpan = document.getElementById("file-name");
        const fileMetadataSpan = document.getElementById("file-metadata");
        const removeFileBtn = document.getElementById("remove-file-btn");
        const statusDiv = document.getElementById("status");
        const progressContainer = document.getElementById("progress-container");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        const isSystemDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const storedTheme = localStorage.getItem("theme");
        const initialThemeIsDark =
          storedTheme === "dark" || (storedTheme === null && isSystemDark);
        setTheme(initialThemeIsDark);

        themeToggle.addEventListener("click", () => {
          const isDark = body.classList.contains("dark");
          setTheme(!isDark);
        });

        fileInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          fileNameSpan.textContent = file.name;
          fileMetadataSpan.textContent = `File size: ${formatBytes(file.size)}`;
          fileInfo.classList.remove("hidden");
          form.classList.add("hidden");
          progressContainer.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "0 MB processed";
          showLoadingSpinner(true);

          const source = new EventSource("/progress");
          source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const processed = data.processed_bytes;
            const total = file.size;
            const percent = ((processed / total) * 100).toFixed(2);

            progressBar.style.width = percent + "%";
            progressBar.textContent = percent + "%";
            progressText.textContent =
              formatBytes(processed) + " of " + formatBytes(total);
          };

          const formData = new FormData();
          formData.append("zim_file", file);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });
            const result = await response.json();
            source.close();

            if (response.ok) {
              window.location.href = "/viewer.html";
            } else {
              statusDiv.innerHTML = `<div class="p-4 rounded-xl font-medium">${
                result.message || "Unknown error"
              }</div>`;
              const isDark = body.classList.contains("dark");
              const statusMsg = statusDiv.querySelector("div");
              statusMsg.classList.toggle("bg-red-100", !isDark);
              statusMsg.classList.toggle("text-red-700", !isDark);
              statusMsg.classList.toggle("bg-red-900", isDark);
              statusMsg.classList.toggle("text-red-300", isDark);
            }
          } catch (e) {
            source.close();
            statusDiv.innerHTML = `<div class="p-4 rounded-xl font-medium">Error: ${e.message}</div>`;
            const isDark = body.classList.contains("dark");
            const statusMsg = statusDiv.querySelector("div");
            statusMsg.classList.toggle("bg-red-100", !isDark);
            statusMsg.classList.toggle("text-red-700", !isDark);
            statusMsg.classList.toggle("bg-red-900", isDark);
            statusMsg.classList.toggle("text-red-300", isDark);
          } finally {
            showLoadingSpinner(false);
          }
        });

        removeFileBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fileInput.value = null;
          form.classList.remove("hidden");
          fileInfo.classList.add("hidden");
          progressContainer.classList.add("hidden");
        });

        form.addEventListener("dragover", (e) => e.preventDefault());
        form.addEventListener("drop", (e) => {
          e.preventDefault();
          if (e.dataTransfer.files[0]) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event("change"));
          }
        });
      });
    </script>
  </body>
</html>
