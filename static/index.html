<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust ZIM Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .spinner {
        border-top-color: #3b82f6;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
      }
      @-webkit-keyframes spin {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /*  FIX: Artilces uses default stylings from zim file itself so these custom styling is not applied*/
      /* styling for articles */
      .mediawiki {
        font-family: sans-serif;
        line-height: 1.6;
        color: #202122;
        background-color: #f8f9fa;
      }

      .mw-body {
        max-width: 800px;
        margin: auto;
        padding: 1em;
        background-color: #fff;
        border: 1px solid #a2a9b1;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .mw-page-title-main {
        font-size: 2em;
        font-weight: normal;
        margin-bottom: 0.3em;
        padding-bottom: 0.3em;
        border-bottom: 1px solid #a2a9b1;
      }

      h2 .mw-headline {
        font-size: 1.5em;
        font-weight: normal;
        border-bottom: 1px solid #a2a9b1;
        padding-bottom: 0.17em;
        margin: 1em 0 0.5em;
      }

      h3 .mw-headline {
        font-size: 1.2em;
        font-weight: bold;
        margin: 1em 0 0.5em;
      }

      p {
        margin: 1em 0;
      }

      a {
        color: #36c;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      img {
        max-width: 100%;
        height: auto;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        padding: 3px;
        box-sizing: border-box;
      }

      .thumb {
        border: 1px solid #a2a9b1;
        background-color: #f9f9f9;
        padding: 0.2em;
        overflow: hidden;
        margin-bottom: 0.5em;
      }

      .tright {
        clear: right;
        float: right;
        margin: 0.5em 0 0.8em 1.4em;
      }

      .thumbinner {
        text-align: center;
        overflow: hidden;
      }

      .thumbcaption {
        font-size: 94%;
        padding: 3px;
      }

      .mw-highlight {
        background-color: #f8f9fa;
        border: 1px dashed #a2a9b1;
        padding: 0.5em;
        overflow: auto;
        margin: 1em 0;
      }

      pre {
        margin: 0;
      }

      .reflist {
        font-size: 90%;
        margin-bottom: 0.5em;
        list-style-type: decimal;
      }

      details {
        margin: 1em 0;
      }

      details > summary {
        cursor: pointer;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300 relative"
    >
      <a
        href="https://github.com/Harshit-Dhanwalkar/Zim-viewer"
        target="_blank"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
      >
        <svg
          class="w-8 h-8"
          fill="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.418 2.864 8.167 6.83 9.5.5.092.682-.217.682-.483 0-.237-.008-.888-.011-1.745-2.782.605-3.37-1.344-3.37-1.344-.454-1.157-1.11-1.465-1.11-1.465-.908-.62.069-.608.069-.608 1.004.07 1.531 1.032 1.531 1.032.892 1.53 2.342 1.088 2.91.83.091-.64.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.942 0-1.09.39-1.984 1.029-2.68-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.022.796-.22 1.635-.33 2.47-.33.834 0 1.674.11 2.47.33 1.91-1.292 2.75-1.022 2.75-1.022.546 1.378.202 2.397.098 2.65.64.696 1.029 1.59 1.029 2.68 0 3.841-2.339 4.686-4.568 4.935.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482C19.14 20.18 22 16.431 22 12.017 22 6.484 17.522 2 12 2z"
            clip-rule="evenodd"
          />
        </svg>
      </a>

      <h1
        class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-gray-900"
      >
        Rust ZIM Viewer
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Upload a `.zim` file to view its simulated contents.
      </p>

      <form
        id="upload-form"
        class="relative w-full border-2 border-dashed border-gray-300 rounded-xl p-6 sm:p-12 text-center transition-colors duration-200 hover:border-blue-500"
      >
        <input
          id="file-upload"
          type="file"
          name="zim_file"
          accept=".zim"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center justify-center space-y-4">
          <svg
            class="w-12 h-12 text-gray-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="17 8 12 3 7 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <line
              x1="12"
              x2="12"
              y1="3"
              y2="15"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p class="text-gray-500 font-medium">
            Drag and drop your file here, or
            <span class="text-blue-600 underline">browse</span>
          </p>
          <p class="text-sm text-gray-400">Supported file type: .zim</p>
        </div>
      </form>

      <div
        id="file-info"
        class="mt-6 p-4 bg-gray-100 rounded-xl flex items-center justify-between hidden"
      >
        <div class="flex items-center space-x-3">
          <svg
            class="w-6 h-6 text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <polyline
              points="14 2 14 8 20 8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <div>
            <span id="file-name" class="font-medium text-gray-700 block"></span>
            <span id="file-metadata" class="text-xs text-gray-500"></span>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button
            id="remove-file-btn"
            class="text-red-500 hover:text-red-700 font-semibold text-sm transition-colors duration-200"
          >
            Remove
          </button>
          <button
            id="clean-cache-btn"
            class="text-gray-500 hover:text-gray-700 font-semibold text-sm transition-colors duration-200"
          >
            Clean Cache
          </button>
        </div>
      </div>

      <div id="status" class="mt-8"></div>
      <div id="progress-container" class="mt-4 hidden">
        <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
          <div
            id="progress-bar"
            class="bg-blue-500 h-6 text-xs text-white text-center leading-6"
            style="width: 0%"
          >
            0%
          </div>
        </div>
        <div id="progress-text" class="text-gray-600 text-sm mt-2">
          0 MB processed
        </div>
      </div>

      <div id="search-container" class="mt-8 hidden">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-semibold">ZIM Content</h2>
          <button
            id="browse-btn"
            type="button"
            class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
          >
            Browse All Articles
          </button>
        </div>
        <form id="search-form" class="flex space-x-2">
          <input
            type="text"
            id="search-query"
            name="query"
            placeholder="Search articles..."
            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
          />
          <button
            type="submit"
            class="inline-flex items-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            Search
          </button>
        </form>
      </div>

      <div id="content-display" class="mt-8 hidden"></div>

      <div
        id="search-results-display"
        class="mt-8 p-6 bg-white border border-gray-200 rounded-xl shadow-inner overflow-y-auto max-h-[60vh] hidden"
      ></div>

      <div id="loading-spinner" class="mt-8 text-center hidden">
        <div
          class="spinner inline-block w-8 h-8 border-4 border-gray-200 rounded-full"
        ></div>
        <p class="text-gray-500 mt-2">Loading...</p>
      </div>
    </div>

    <script>
      let currentFilePath = null;

      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showLoadingSpinner(show) {
        const spinner = document.getElementById("loading-spinner");
        if (show) {
          spinner.classList.remove("hidden");
        } else {
          spinner.classList.add("hidden");
        }
      }

      function hideAllContent() {
        document.getElementById("content-display").classList.add("hidden");
        document
          .getElementById("search-results-display")
          .classList.add("hidden");
        document.getElementById("status").innerHTML = "";
      }

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("upload-form");
        const fileInput = document.getElementById("file-upload");
        const fileInfo = document.getElementById("file-info");
        const fileNameSpan = document.getElementById("file-name");
        const fileMetadataSpan = document.getElementById("file-metadata");
        const removeFileBtn = document.getElementById("remove-file-btn");
        const cleanCacheBtn = document.getElementById("clean-cache-btn");
        const statusDiv = document.getElementById("status");
        const progressContainer = document.getElementById("progress-container");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const contentDisplay = document.getElementById("content-display");
        const searchContainer = document.getElementById("search-container");
        const searchForm = document.getElementById("search-form");
        const searchQueryInput = document.getElementById("search-query");
        const searchResultsDisplay = document.getElementById(
          "search-results-display",
        );
        const browseBtn = document.getElementById("browse-btn");

        fileInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          fileNameSpan.textContent = file.name;
          fileMetadataSpan.textContent = `File size: ${formatBytes(file.size)}`;
          fileInfo.classList.remove("hidden");
          form.classList.add("hidden");
          hideAllContent();
          searchContainer.classList.add("hidden");

          progressContainer.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "0 MB processed";

          const source = new EventSource("/progress");
          source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const processed = data.processed_bytes;
            const total = file.size;
            const percent = ((processed / total) * 100).toFixed(2);

            progressBar.style.width = percent + "%";
            progressBar.textContent = percent + "%";
            progressText.textContent =
              formatBytes(processed) + " of " + formatBytes(total);
          };

          const formData = new FormData();
          formData.append("zim_file", file);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });
            const result = await response.json();
            source.close();

            if (response.ok) {
              currentFilePath = result.file_metadata.persisted_file_path;
              fileMetadataSpan.textContent += ` | Articles: ${result.file_metadata.article_count}`;

              progressContainer.classList.add("hidden");
              searchContainer.classList.remove("hidden");
              progressBar.style.width = "100%";
              progressBar.textContent = "100%";

              // Automatically trigger a browse to show the content
              browseBtn.click();
            } else {
              statusDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-xl font-medium">${result.message || "Unknown error"}</div>`;
            }
          } catch (e) {
            source.close();
            statusDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-xl font-medium">Error: ${e.message}</div>`;
          }
        });

        removeFileBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fileInput.value = null;
          form.classList.remove("hidden");
          fileInfo.classList.add("hidden");
          hideAllContent();
          progressContainer.classList.add("hidden");
          searchContainer.classList.add("hidden");
          currentFilePath = null;
        });

        cleanCacheBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (
            !confirm(
              "Are you sure you want to clean the cache and remove all uploaded files?",
            )
          ) {
            return;
          }

          showLoadingSpinner(true);
          try {
            const response = await fetch("/clean_cache", { method: "POST" });
            if (response.ok) {
              alert("Cache cleaned successfully.");
              // Reset the UI after successful deletion
              fileInput.value = null;
              form.classList.remove("hidden");
              fileInfo.classList.add("hidden");
              hideAllContent();
              searchContainer.classList.add("hidden");
              currentFilePath = null;
            } else {
              const errorText = await response.text();
              alert(`Failed to clean cache: ${errorText}`);
            }
          } catch (e) {
            alert(`Error: ${e.message}`);
          } finally {
            showLoadingSpinner(false);
          }
        });

        searchForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const query = searchQueryInput.value.trim();
          if (!query || !currentFilePath) return;

          hideAllContent();
          searchResultsDisplay.classList.remove("hidden");
          showLoadingSpinner(true);

          try {
            const response = await fetch("/search", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                query: query,
                file_path: currentFilePath,
              }),
            });

            showLoadingSpinner(false);

            if (response.ok) {
              const results = await response.json();
              if (results.length > 0) {
                const resultsHtml = results
                  .map(
                    (article) =>
                      `<li class="border-b last:border-b-0 py-2"><a href="/article/${encodeURIComponent(article.title)}" class="text-blue-500 hover:underline">${article.title}</a></li>`,
                  )
                  .join("");
                searchResultsDisplay.innerHTML = `<h2 class="text-xl font-semibold mb-4">Search Results (${results.length} found)</h2><ul class="list-inside list-disc">${resultsHtml}</ul>`;
              } else {
                searchResultsDisplay.innerHTML = `<p class="text-center text-gray-500">No results found for "${query}".</p>`;
              }
            } else {
              const errorText = await response.text();
              searchResultsDisplay.innerHTML = `<p class="text-center text-red-500">Error during search: ${errorText}</p>`;
            }
          } catch (e) {
            showLoadingSpinner(false);
            searchResultsDisplay.innerHTML = `<p class="text-center text-red-500">Error: ${e.message}</p>`;
          }
        });

        browseBtn.addEventListener("click", async () => {
          if (!currentFilePath) return;

          hideAllContent();
          searchResultsDisplay.classList.remove("hidden");
          showLoadingSpinner(true);

          try {
            const response = await fetch("/browse", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ file_path: currentFilePath }),
            });

            showLoadingSpinner(false);

            if (response.ok) {
              const results = await response.json();
              if (results.length > 0) {
                const resultsHtml = results
                  .map(
                    (article) =>
                      `<li class="border-b last:border-b-0 py-2"><a href="/article/${encodeURIComponent(article.title)}" class="text-blue-500 hover:underline">${article.title}</a></li>`,
                  )
                  .join("");
                searchResultsDisplay.innerHTML = `<h2 class="text-xl font-semibold mb-4">Browse Articles (${results.length} found)</h2><ul class="list-inside list-disc">${resultsHtml}</ul>`;
              } else {
                searchResultsDisplay.innerHTML = `<p class="text-center text-gray-500">No articles found in archive.</p>`;
              }
            } else {
              const errorText = await response.text();
              searchResultsDisplay.innerHTML = `<p class="text-center text-red-500">Error during Browse: ${errorText}</p>`;
            }
          } catch (e) {
            showLoadingSpinner(false);
            searchResultsDisplay.innerHTML = `<p class="text-center text-red-500">Error: ${e.message}</p>`;
          }
        });

        // Event listener for article links
        searchResultsDisplay.addEventListener("click", (e) => {
          if (e.target.tagName === "A") {
            e.preventDefault();
            const url = new URL(e.target.href);
            const title = decodeURIComponent(url.pathname.split("/").pop());
            fetchArticle(title);
          }
        });

        form.addEventListener("dragover", (e) => e.preventDefault());
        form.addEventListener("drop", (e) => {
          e.preventDefault();
          if (e.dataTransfer.files[0]) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event("change"));
          }
        });
      });

      async function fetchArticle(title) {
        const articleContentDiv = document.getElementById("content-display");
        articleContentDiv.innerHTML = "Loading article...";
        document
          .getElementById("search-results-display")
          .classList.add("hidden");
        articleContentDiv.classList.remove("hidden");
        showLoadingSpinner(true);
        try {
          const response = await fetch(`/article/${encodeURIComponent(title)}`);
          if (!response.ok) {
            throw new Error(`Failed to fetch article: ${response.statusText}`);
          }
          const content = await response.text();
          const styledContent = applyWikipediaStyling(content);
          articleContentDiv.innerHTML = styledContent;
        } catch (error) {
          articleContentDiv.innerHTML = `Error loading article: ${error.message}`;
        } finally {
          showLoadingSpinner(false);
        }
      }

      function applyWikipediaStyling(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, "text/html");
        const body = doc.body;

        // Add a style block to override ZIM file's CSS with higher specificity
        const customStyle = document.createElement("style");
        customStyle.innerHTML = `
          .mediawiki h1, .mediawiki h2, .mediawiki h3 {
            font-family: sans-serif !important;
            color: #333333 !important;
            border-bottom: 1px solid #a2a9b1 !important;
          }
          .mediawiki p {
            font-family: sans-serif !important;
            line-height: 1.6 !important;
            color: #202122 !important;
          }
          .mediawiki a {
            color: #36c !important;
            text-decoration: none !important;
          }
          .mediawiki a:hover {
            text-decoration: underline !important;
          }
        `;
        doc.head.appendChild(customStyle);

        // Add Wikipedia's container and body classes
        const mainContainer = document.createElement("div");
        mainContainer.classList.add(
          "mediawiki",
          "mw-hide-empty-elt",
          "ns-0",
          "ns-subject",
          "stable",
          "skin-minerva",
          "action-view",
          "animations",
        );

        const viewportDiv = document.createElement("div");
        viewportDiv.id = "mw-mf-viewport";
        viewportDiv.className = "feature-header-v2";

        const pageCenterDiv = document.createElement("div");
        pageCenterDiv.id = "mw-mf-page-center";

        const contentDiv = document.createElement("div");
        contentDiv.id = "content";
        contentDiv.className = "mw-body";

        const bodyContentDiv = document.createElement("div");
        bodyContentDiv.id = "bodyContent";
        bodyContentDiv.className = "content mw-parser-output";

        // Move the article content into the new bodyContent div
        while (body.firstChild) {
          bodyContentDiv.appendChild(body.firstChild);
        }

        // Build the new structure
        contentDiv.appendChild(bodyContentDiv);
        pageCenterDiv.appendChild(contentDiv);
        viewportDiv.appendChild(pageCenterDiv);
        mainContainer.appendChild(viewportDiv);

        // Apply specific classes to headings and other elements
        mainContainer
          .querySelectorAll("h1.section-heading .mw-headline")
          .forEach((h1) => h1.classList.add("mw-page-title-main"));
        mainContainer
          .querySelectorAll("h2.section-heading .mw-headline")
          .forEach((h2) => h2.classList.add("mw-headline"));
        mainContainer
          .querySelectorAll("h3.section-heading .mw-headline")
          .forEach((h3) => h3.classList.add("mw-headline"));

        // Replace the body's content with the new styled container
        const newBody = document.createElement("div");
        newBody.appendChild(mainContainer);
        return newBody.innerHTML;
      }
    </script>
  </body>
</html>
